---
title: "MC_achilles"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

load("./Data/cellline_datasets.rda")
load("./Data/prism_datasets.rda")
```
Junk
```{r}
which(prism.cl[,20] %in% rownames(prism.achilles))
for(n in 1:481) {prism.cl[n,20] %in% rownames(prism.achilles)}
keep.rows = apply(prism.cl,1,function(x){prism.cl[x,1] %in% rownames(prism.achilles) })
```









Cleanup of prism.achilles 
na removal
```{r}
which(is.na(prism.achilles[,14]))
prism.achilles[275:280,14]
prism.achilles[320:325,14]
```


------- na test
z <- c(1:350)
for(n in 1:350) {z[n] <- sum(is.na(prism.achilles[n,]))}
z
----------

```{r}
na.achilles <- c(277,309,323)
rownames(prism.achilles[na.achilles,])
sum(is.na(prism.achilles[na.achilles,]))
prism.achilles <- prism.achilles[-na.achilles,]
sum(is.na(prism.achilles))
dim(prism.achilles)
```

Make Prism.achilles numeric
```{r}

prism.achilles.numeric <- apply(prism.achilles, 2, as.numeric)
```




Sort Prism.cl by depmap_id resulting in prism.cl.ordered
```{r}
prism.cl[1:3,1:3]

order(prism.cl$DepMap_ID)
prism.cl.ordered <- prism.cl[order(prism.cl$DepMap_ID),]
dim(prism.cl.ordered)

rownames(prism.cl.ordered) <- 1:481
rownames(prism.cl.ordered)[1:30]
prism.cl.ordered[1:30,1:3]

```



```{r}
a <- c(1:481)

for(n in 1:481) {a[n] <- (prism.cl.ordered[n,1] %in% rownames(prism.achilles))}
prism.cl.ordered[1:3,]
b <- which(a == 0)
prism.cl.ordered.achilles <- prism.cl.ordered[-b, ]
dim(prism.cl.ordered.achilles)
rownames(prism.cl.ordered.achilles) <- 1:347

dim(prism.cl.ordered.achilles)
prism.cl.ordered.achilles
dim(prism.cl.ordered)
prism.cl.ordered.achilles[1:10,1]
rownames(prism.achilles.numeric)[1:10]
```

Find PanCan Cellines in prism.cl.achilles
```{r}
prism.cl.pancan.rownumbers <- c(which(prism.cl.ordered.achilles[,20] == 'Pancreatic Cancer'))
prism.cl.pancan.rownumbers
pancan.cl.names <- prism.cl.ordered.achilles[prism.cl.pancan.rownumbers,1]
pancan.cl.names

which(prism.cl.achilles[,20] == 'Pancreatic Cancer')

prism.cl.ordered.achilles[prism.cl.pancan.rownumbers,20]
rownames(prism.achilles.numeric)[prism.cl.pancan.rownumbers]
```
```{r}
prism.cl.ordered.achilles[1:50,20]
prism.cl.ordered.achilles[1:50,1]
```



```{r}
rownames(prism.cl.ordered.achilles)[1:10]
prism.cl.ordered.achilles[1:10,1]
rownames(prism.achilles.numeric)[1:10]
```


The data frame prism.achilles consists of gene knockdown scores. The score is a measure of how essential/important is a particular gene for the cell survival. This score reflects whether upon knocking down that genes does the cell reduce its proliferation or increases it or has no change. Smaller values refers to higher essentiality. The rows of this matrix are the gene names and the columns are the cancer cell line identifiers.

Exploration
```{r}
dim(prism.achilles.numeric)
prism.achilles.numeric[1:10,1]
```


```{r}
prism.cl.pancan
prism.achilles.numeric.pancan <- prism.achilles.numeric[prism.cl.pancan,]

prism.achilles.numeric.pancan[1:10,1]
```


```{r}
is.numeric(prism.achilles.numeric.pancan)
hist(prism.achilles.numeric.pancan[1,])
hist(prism.achilles.numeric[1,])
quantile(prism.achilles.numeric.pancan,probs=seq(0,1,.1))
```
```{r}
quantile(prism.achilles.numeric,probs=seq(0,1,.1))
quantile(prism.achilles.numeric,prob=0.1)
```
```{r}

dim(prism.achilles.numeric)
prism.achilles.numeric[345:347,1:5]
dim(prism.achilles.numeric)
dim(prism.achilles)
rownames(prism.achilles.numeric) <- rownames(prism.achilles)
```

Neuen Dataframe fÃ¼r Untersuchungen an prism.achilles.numeric
```{r}
achilles.research.dataframe <- prism.achilles[1:10,]
achilles.research.dataframe[1:10,1:18119] <- 0
rownames(achilles.research.dataframe) <- c('max','mean','min','10%quantile','Pancanmean','is(r5<r4)','stdev','empty8','empty9','empty10')

achilles.research.dataframe[1,] <- apply(prism.achilles.numeric, 2, max)
achilles.research.dataframe[2,] <- apply(prism.achilles.numeric, 2, mean)
achilles.research.dataframe[3,] <- apply(prism.achilles.numeric, 2, min)
achilles.research.dataframe[4,] <- apply(prism.achilles.numeric, 2, function(x){quantile(x,prob=0.1)})
achilles.research.dataframe[5,] <- apply(prism.achilles.numeric.pancan, 2, mean)
achilles.research.dataframe[6,] <- apply(achilles.research.dataframe, 2, function(x) {return(x[4] > x[5])})
achilles.research.dataframe[7,] <- apply(prism.achilles.numeric, 2, var)

```


```{r}
achilles.research.dataframe[1:6,1:100]
which(achilles.research.dataframe[6,] == 1)
achilles.research.dataframe[1:7,which(achilles.research.dataframe[6,] == 1)]
```


```{r}

```
```{r}
cor.mat.achilles[779,782]
```
```{r}
merlinsvariable <- 10000
cor.mat.achilles <- cor(prism.achilles.numeric.pancan[,1:merlinsvariable])
interesting.cor.values <- which(cor.mat.achilles > 0.90 & cor.mat.achilles < 1 ) 
interesting.cor.rows <- (((interesting.cor.values - (interesting.cor.values %% merlinsvariable)) /merlinsvariable) +1)
interesting.cor.cols <- (interesting.cor.values %% merlinsvariable)
cor.mat.achilles[interesting.cor.rows,  interesting.cor.cols]
```


k-means clustering

Using the most variable, thus informative genes
We first reduce our dataset to take the most variable gene, which are expected to carry most of the information about the samples:
```{r}
## compute variance over all rows of the data.frame (hence genes)
topVar = apply(prism.achilles.numeric, 2, var) 
summary(topVar)
```
```{r}
## filtering to keep genes which have a variance greater than the 75% percentile
prism.achilles.numeric.topVar = prism.achilles.numeric[,topVar > quantile(topVar, probs = 0.75)] 
dim(prism.achilles.numeric.topVar)
```


Clustering by depmap
```{r}
mydata <- prism.achilles.numeric.topVar
# Determine number of clusters
wss.depmap <- (nrow(mydata)-1)*sum(apply(mydata,2,var))
wss.depmap
for (i in 2:100) wss.depmap[i] <- sum(kmeans(mydata, centers=i)$withinss)
```

```{r}
wss.depmap
plot(1:100, wss.depmap, type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")
plot(1:20, wss.depmap[1:20], type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")
```


```{r}
km.depmap = kmeans(x=prism.achilles.numeric.topVar, 
            centers = 2, 
            nstart = 10)
km.depmap$cluster[1:10]

```


```{r}
summary(km.depmap)
prism.cl.pancan
km.depmap$cluster[prism.cl.pancan]
```

Clustering by genes
```{r}
mydata <- prism.achilles.numeric.topVar
# Determine number of clusters

wss.genes <- (ncol(mydata)-1)*sum(apply(mydata,1,var))
dim(mydata)
for (i in seq(500,1000, by = 10)) wss.genes[i] <- sum(kmeans(t(mydata), centers=i, iter.max = 500)$withinss)
```
```{r}
for (i in 1:499) wss.genes[i] <- sum(kmeans(t(mydata), centers=i, iter.max = 500)$withinss)
```

```{r}
wss.genes
dim(wss.genes)
plot(wss.genes[100:1000], type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")
plot(wss.genes[100:500], type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")
```


```{r}
km.genes = kmeans(x=prism.achilles.numeric.topVar, 
            centers = 2, 
            nstart = 10)
km.genes$cluster[1:10]

```


```{r}
summary(km.genes)
prism.cl.pancan
km.genes$cluster[prism.cl.pancan]
```
